I am only moderately experienced with C++, so there may be obvious optimisations.

Please be gentle.